var Grid=function(){var j=function(a,b){b=b||{};this.container=document.getElementById(a);this.callBack=b.onUpdate||function(){};this.times=this.constructTimesArray(b.gridStr||"");this.readOnly=b.readOnly||!1;this.world={width:this.container.clientWidth,height:this.container.clientHeight};this.dutyColor=this.readOnly?"black":"blue";this.mouseDown=!1;this.drag={};this.constructCanvas()};j.prototype={constructCanvas:function(){var a=document.createElement("canvas");a.style.cssText=";position: absolute; background-color: white; z-index: 1000;";
a.width=this.world.width;a.height=this.world.height;this.container.appendChild(this.gridCanvas=a);var a=document.createElement("canvas"),b=this;a.style.cssText=";position: absolute; z-index: 1100;";a.width=this.world.width;a.height=this.world.height;this.container.appendChild(this.dutyCanvas=a);if(!this.readOnly)for(var a=["mousemove","mousedown","mouseup","mouseout"],c=0;c<a.length;c++)(function(a){b.dutyCanvas.addEventListener(a,function(c){b[a+"Handler"](c)},!1)})(a[c]);this.dutyCanvas.onselectstart=
function(){return!1};this.drawLogGrid();this.drawDutyStatusLine();this.readOnly||this.callBack()},mousedownHandler:function(a){this.mouseDown=!0;this.updateDrag(this.getMouseTime(a))},mouseupHandler:function(){this.mouseDown=!1;this.saveDrag();this.clearDutyLines();this.drawDutyStatusLine();this.readOnly||this.callBack()},mousemoveHandler:function(a){if(!this.mouseDown)return!1;this.updateDrag(this.getMouseTime(a));this.clearDutyLines();this.drawDutyStatusLine()},mouseoutHandler:function(){if(this.drag.range&&
this.drag.range.end>93)this.drag.range.end=96,this.mouseUpHandler()},getMouseTime:function(a){var b=this.world.width/96,c=this.world.height/4,d;d=this.container;var e=0,f=0;do e+=d.offsetTop||0,f+=d.offsetLeft||0,d=d.offsetParent;while(d);d=[f,e];var e=this.gridCanvas,h=f=0;do f+=e.scrollTop||0,h+=e.scrollLeft||0,e=e.parentNode;while(e);e=[h,f];return{min:(a.clientX-(d[0]-e[0]))/b|0,duty:((a.clientY-(d[1]+1)+e[1])/c|0)+1}},updateDrag:function(a){this.drag.range=this.drag.range||{start:a.min};this.drag.range.end=
a.min;this.drag.duty=a.duty},saveDrag:function(){for(var a=this.drag.range,b=a.start;b<a.end;b++)this.times[b]=this.drag.duty;this.drag={}},drawLogGrid:function(){var a=this.gridCanvas.getContext("2d"),b=this.world.width/24;a.lineWidth=1;a.beginPath();a.strokeStyle="#ccc";for(var c=1;c<=24;c++){var d=b*c+0.5-b/2;a.moveTo(d,10);a.lineTo(d,this.world.height-10)}a.stroke();a.closePath();a.beginPath();a.strokeStyle="black";for(c=1;c<=24;c++)d=b*c+0.5,a.moveTo(d,0),a.lineTo(d,this.world.height);for(b=
1;b<=3;b++)c=this.world.height/4*b+0.5,a.moveTo(0,c),a.lineTo(this.world.width,c);a.stroke();a.closePath()},drawDutyStatusLine:function(){var a=this.dutyCanvas.getContext("2d"),b=this.world.width/96,c=this.world.height/4,d=!1;a.lineWidth=2;a.beginPath();a.strokeStyle=this.dutyColor;for(var e=0,f=this.times.length;e<f;e++){var h=this.times[e],i=c*h-c/2,g=e*b;d&&d!=h&&(a.moveTo(g,c*d-c/2+0.5),a.lineTo(g,i));d=h;a.moveTo(g,i);a.lineTo(g+b,i)}a.closePath();a.stroke();if("range"in this.drag){d=this.drag.range;
a.beginPath();a.strokeStyle="red";for(e=d.start;e<d.end;e++)i=c*this.drag.duty-c/2,g=e*b,a.moveTo(g,i),a.lineTo(g+b,i);a.closePath();a.stroke()}},clearDutyLines:function(){this.dutyCanvas.getContext("2d").clearRect(0,0,this.world.width,this.world.height)},toString:function(){return this.times.join("")},getHourTotals:function(){if(this.times.length==0)return!1;for(var a=this.toString(),b="off sleeper drive onduty".split(" "),c={},d=0;d<b.length;d++){var e=a.match(RegExp(d+1,"g"));c[b[d]]=e?e.length/
4:0}return c},constructTimesArray:function(a){var b=a||"",a=[];if(b&&b.length==96)a=b.split("");else for(b=0;b<96;b++)a.push(1);return a}};return j}();